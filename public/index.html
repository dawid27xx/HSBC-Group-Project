<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
</head>
<body>
    <nav class="navbar bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand text-light"><strong>Portman</strong></a>
            <span class="nav-item text-light fs-5">Welcome, <strong id="username">User</strong></span>
        </div>
    </nav>

    <main class="container my-4">
        <div class="row">
            <section id="net-worth" class="col-md-8 mb-4">
                <h2>Net Worth Over Time</h2>
                <canvas id="netWorthChart"></canvas>
            </section>
            <section id="market-updates" class="col-md-4">
                <div class="container">
                    <h2>Recent Transactions</h2>
                    <table class="table table-striped" id="transactionTable">
                        <thead>
                            <tr>
                                <th>Transaction type</th>
                                <th>Quantity</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
            
                        </tbody>
                        
                    </table>
                </div>
            </section>
        </div>
    </main>

    <div class="container">
        <h2>Portfolios</h2>
        <table class="table table-striped" id="portfolioTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Exchange</th>
                    <th>Manage</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- <footer class="bg-primary text-white text-center py-3">
        <p>&copy; 2025 Portfolio Manager</p>
    </footer> -->

    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script>
        // Populate username from JWT in localStorage
        const token = localStorage.getItem('token');
        if (token) {
            try {
                const payload = jwt_decode(token);
                if (payload.username) {
                    document.getElementById('username').textContent = payload.username;
                }
            } catch (e) {
                console.error('Invalid token', e);
            }
        }

        const portfolioIds = [];
        const portfolioNames = {};

        // Fetch the portfolio IDs and names for the user
        fetch('userPortfolio/userPortfolio', {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => response.json())
            .then(data => {
                data.forEach(pa => {
                    portfolioIds.push(pa.portfolio_id);
                });
                fetchPortfolioDetails(); // Fetch portfolio details after we have IDs
            })
            .catch(err => console.error('Error fetching user portfolio IDs:', err));

        // Fetch portfolio details like name and exchange
        const fetchPortfolioDetails = () => {
            fetch(`/portfolio/portfolio`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => response.json())
                .then(data => {
                    data.forEach((portfolio) => {
                        portfolioNames[portfolio.id] = portfolio.name; // Save portfolio names
                    });
                    // Fetch data for the first portfolio after loading portfolio details
                    fetchPortfolioData(portfolioIds[0], 0); // Start with the first portfolio
                })
                .catch(err => console.error('Error fetching portfolio details:', err));
        };

        // Fetch portfolio data by portfolioId and update the chart
        const fetchPortfolioData = (portfolioId, index) => {
            fetch(`portfolio/portfolio/getCumulativePricesforPortfolio/${portfolioId}`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => response.json())
                .then(data => {
                    console.log(`Data for Portfolio ${portfolioId}:`, data);
                    if (data && data.dates && data.values) {
                        updateChart(data.dates, data.values, portfolioNames[portfolioId], index);
                    } else {
                        console.error(`No data for portfolio ${portfolioId}`);
                    }
                    // After processing, move to the next portfolio if it exists
                    if (portfolioIds[index + 1]) {
                        fetchPortfolioData(portfolioIds[index + 1], index + 1);
                    }
                })
                .catch(err => {
                    console.error(`Error fetching data for portfolio ${portfolioId}:`, err);
                });
        };

        // Global variable for the chart
        let chart = null;

        // Function to update the chart with the data for each portfolio
        const updateChart = (dates, values, portfolioName, index) => {
            if (!chart) {
                // Create the chart if it doesn't exist yet
                chart = new Chart("netWorthChart", {
                    type: "line",
                    data: {
                        labels: dates,  // Assuming all portfolios have the same dates
                        datasets: [{
                            label: portfolioName,  // Use the portfolio name here
                            backgroundColor: `rgba(${(index * 50)}, 123, 255, 0.2)`,
                            borderColor: `rgba(${(index * 50)}, 123, 255, 1)`,
                            data: values,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'category', // String-based months
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Net Worth (GBP)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                        },
                    }
                });
            } else {
                // If chart already exists, just add the new dataset
                chart.data.datasets.push({
                    label: portfolioName,  // Use the portfolio name here
                    backgroundColor: `rgba(${(index * 50)}, 123, 255, 0.2)`,
                    borderColor: `rgba(${(index * 50)}, 123, 255, 1)`,
                    data: values,
                    fill: true,
                });
                chart.update();  // Update the chart
            }
        };

        // Populate the Portfolio Table
        // Populate the Portfolio Table
        const table = document.getElementById('portfolioTable').getElementsByTagName('tbody')[0];

        fetch(`/portfolio/portfolio`, {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => response.json())
            .then(data => {
                data.forEach((p) => {
                    const newRow = table.insertRow();
                    const pName = newRow.insertCell(0);
                    const pExchange = newRow.insertCell(1);
                    const manageButton = newRow.insertCell(2);

                    pName.innerHTML = p.name;
                    pExchange.innerHTML = p.exchange;
                    // Set up the manage button with an onClick event
                    manageButton.innerHTML = `<button class="btn btn-outline-dark" onclick="managePortfolio(${p.id}, '${p.name}', '${p.exchange}')">Manage</button>
`;
                });
            })
            .catch(err => console.error('Error fetching portfolio details:', err));

// Function to handle the Manage button click
function managePortfolio(id, name, exchange) {
    // Store the portfolio ID in localStorage
    localStorage.setItem('portfolioId', id);
    localStorage.setItem('portfolioName', name);
    localStorage.setItem('portfolioExchange', exchange);
    // Redirect to manage.html
    window.location.href = 'manage.html';
}

        

        const table2 = document.getElementById('transactionTable').getElementsByTagName('tbody')[0];

        // update url
        fetch(`/transaction/transaction`, {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
        .then(response => response.json())
        .then(data => {
            data = data.reverse();
            // 
            data.forEach((p) => { 
                // date we're getting: "datetime": "2025-08-29T09:01:28.000Z"
                // new Date(date) <- converts it to standard format that js can understand
                let date = new Date(p.datetime); 
                // options for formatting the date
                const options = { year: 'numeric', month: 'short' , day: 'numeric', hour: '2-digit', minute: '2-digit' };
                // function that converts date objects to strings
                date = date.toLocaleDateString('en-US', options);
                const newRow = table2.insertRow();
                const transactionType = newRow.insertCell(0);
                const quantity = newRow.insertCell(1);
                const dateTime = newRow.insertCell(2);
                transactionType.innerHTML = p.transaction_type.toUpperCase();
                quantity.innerHTML = p.quantity;
                dateTime.innerHTML = date;
            })
        })
    </script>
</body>
</html>
