<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.21/vanta.waves.min.js"></script>

        <style>

        .navbar {
            background-color: #343a40;
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #transactionTable {
            border-radius: 10px;
            overflow: hidden;
        }

        #transactionTable thead {
            background-color: #343a40; /* Dark header */
            color: #fff; /* White text for the header */
        }

        #transactionTable tbody tr:nth-child(even) {
            background-color: #f8f9fa; /* Light gray for even rows */
        }

        #transactionTable tbody tr:nth-child(odd) {
            background-color: #ffffff; /* White for odd rows */
        }

        #transactionTable tbody tr:hover {
            background-color: #e9ecef; /* Light hover effect */
            cursor: pointer;
        }

        #transactionTable th, #transactionTable td {
            vertical-align: middle;
            padding: 12px;
            font-size: 14px;
        }

        #transactionTable th {
            font-weight: bold;
            text-transform: uppercase;
        }

        .buy {
            color: green;
            font-weight: bold;
        }

        .sell {
            color: red;
            font-weight: bold;
        }

        .table-container {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body id="bodyy">
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand text-light">Portfolio Manager</a>
            <span class="nav-item text-light fs-5">Welcome, <strong id="username">User</strong></span>
        </div>
    </nav>

    <main class="container my-4">
        <div class="row">
            <!-- Net Worth Section -->
            <section id="net-worth" class="col-md-8 mb-4">
                <div class="card p-4">
                    <h2 class="text-center text-dark">Net Worth Over Time</h2>
                    <canvas id="netWorthChart"></canvas>
                </div>
            </section>

            <!-- Recent Transactions Section -->
            <section id="market-updates" class="col-md-4">
                <div class="table-container">
                    <h2 class="text-center text-dark mb-4">Recent Transactions</h2>
                    <table class="table table-striped table-hover table-bordered text-center" id="transactionTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Transaction Type</th>
                                <th>Quantity</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- Portfolio Table -->
        <div class="table-container mt-4">
            <h2 class="text-center text-dark">Portfolios</h2>
            <table class="table table-striped" id="portfolioTable">
                <thead class="table-dark">
                    <tr>
                        <th>Name</th>
                        <th>Exchange</th>
                        <th>Manage</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script>
        // Populate username from JWT in localStorage
        const token = localStorage.getItem('token');
        if (token) {
            try {
                const payload = jwt_decode(token);
                if (payload.username) {
                    document.getElementById('username').textContent = payload.username;
                }
            } catch (e) {
                console.error('Invalid token', e);
            }
        }

        const portfolioIds = [];
        const portfolioNames = {};

        // Fetch the portfolio IDs and names for the user
        fetch('userPortfolio/userPortfolio', {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => response.json())
            .then(data => {
                data.forEach(pa => {
                    portfolioIds.push(pa.portfolio_id);
                });
                fetchPortfolioDetails(); // Fetch portfolio details after we have IDs
            })
            .catch(err => console.error('Error fetching user portfolio IDs:', err));

        // Fetch portfolio details like name and exchange
        const fetchPortfolioDetails = () => {
            fetch(`/portfolio/portfolio`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => response.json())
                .then(data => {
                    data.forEach((portfolio) => {
                        portfolioNames[portfolio.id] = portfolio.name; // Save portfolio names
                    });
                    // Fetch data for the first portfolio after loading portfolio details
                    fetchPortfolioData(portfolioIds[0], 0); // Start with the first portfolio
                })
                .catch(err => console.error('Error fetching portfolio details:', err));
        };

        // Fetch portfolio data by portfolioId and update the chart
        const fetchPortfolioData = (portfolioId, index) => {
            fetch(`portfolio/portfolio/getCumulativePricesforPortfolio/${portfolioId}`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data && data.dates && data.values) {
                        updateChart(data.dates, data.values, portfolioNames[portfolioId], index);
                    }
                    // After processing, move to the next portfolio if it exists
                    if (portfolioIds[index + 1]) {
                        fetchPortfolioData(portfolioIds[index + 1], index + 1);
                    }
                })
                .catch(err => console.error(`Error fetching data for portfolio ${portfolioId}:`, err));
        };

        // Global variable for the chart
        let chart = null;

        // Function to update the chart with the data for each portfolio
        const updateChart = (dates, values, portfolioName, index) => {
            if (!chart) {
                chart = new Chart("netWorthChart", {
                    type: "line",
                    data: {
                        labels: dates,
                        datasets: [{
                            label: portfolioName,
                            backgroundColor: `rgba(${(index * 50)}, 123, 255, 0.2)`,
                            borderColor: `rgba(${(index * 50)}, 123, 255, 1)`,
                            data: values,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'category',
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Net Worth (GBP)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                        },
                    }
                });
            } else {
                chart.data.datasets.push({
                    label: portfolioName,
                    backgroundColor: `rgba(${(index * 50)}, 123, 255, 0.2)`,
                    borderColor: `rgba(${(index * 50)}, 123, 255, 1)`,
                    data: values,
                    fill: true,
                });
                chart.update();
            }
        };

        // Populate the Portfolio Table
        // Populate the Portfolio Table
        const table = document.getElementById('portfolioTable').getElementsByTagName('tbody')[0];

        fetch(`/portfolio/portfolio`, {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => response.json())
            .then(data => {
                data.forEach((p) => {
                    const newRow = table.insertRow();
                    const pName = newRow.insertCell(0);
                    const pExchange = newRow.insertCell(1);
                    const manageButton = newRow.insertCell(2);

                    pName.innerHTML = p.name;
                    pExchange.innerHTML = p.exchange;
                    // Set up the manage button with an onClick event
                    manageButton.innerHTML = `<button class="btn btn-outline-dark" onclick="managePortfolio(${p.id}, '${p.name}', '${p.exchange}')">Manage</button>
`;
                });
            });

        const table2 = document.getElementById('transactionTable').getElementsByTagName('tbody')[0];

        // Fetch and populate transaction data
        fetch(`/transaction/transaction`)
    .then(response => response.json())
    .then(data => {
        data.reverse().forEach((p) => {
            let date = new Date(p.datetime);
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            date = date.toLocaleDateString('en-US', options);

            const newRow = table2.insertRow();
            const transactionType = newRow.insertCell(0);
            const quantity = newRow.insertCell(1);
            const dateTime = newRow.insertCell(2);

            // Check if it's a BUY or SELL order and set the innerHTML with a styled <p> tag
            if (p.transaction_type.toUpperCase() === 'BUY') {
                transactionType.innerHTML = `<p style="color: green; font-weight: bold;">BUY</p>`;
            } else if (p.transaction_type.toUpperCase() === 'SELL') {
                transactionType.innerHTML = `<p style="color: red; font-weight: bold;">SELL</p>`;
            } else {
                transactionType.innerHTML = `<p>${p.transaction_type.toUpperCase()}</p>`;
            }

            quantity.innerHTML = p.quantity;
            dateTime.innerHTML = date;
        });
    });
        
// Function to handle the Manage button click
function managePortfolio(id, name, exchange) {
    // Store the portfolio ID in localStorage
    localStorage.setItem('portfolioId', id);
    localStorage.setItem('portfolioName', name);
    localStorage.setItem('portfolioExchange', exchange);
    // Redirect to manage.html
    window.location.href = 'manage.html';
}

        

        
    </script>
</body>
</html>